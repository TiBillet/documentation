"use strict";(self.webpackChunktibillet=self.webpackChunktibillet||[]).push([[3976],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>m});var r=n(7294);function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){l(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,r,l=function(e,t){if(null==e)return{};var n,r,l={},s=Object.keys(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||(l[n]=e[n]);return l}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(l[n]=e[n])}return l}var o=r.createContext({}),u=function(e){var t=r.useContext(o),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},c=function(e){var t=u(e.components);return r.createElement(o.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,l=e.mdxType,s=e.originalType,o=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),d=u(n),m=l,g=d["".concat(o,".").concat(m)]||d[m]||p[m]||s;return n?r.createElement(g,a(a({ref:t},c),{},{components:n})):r.createElement(g,a({ref:t},c))}));function m(e,t){var n=arguments,l=t&&t.mdxType;if("string"==typeof e||l){var s=n.length,a=new Array(s);a[0]=d;var i={};for(var o in t)hasOwnProperty.call(t,o)&&(i[o]=t[o]);i.originalType=e,i.mdxType="string"==typeof e?e:l,a[1]=i;for(var u=2;u<s;u++)a[u]=n[u];return r.createElement.apply(null,a)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},9109:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>o,contentTitle:()=>a,default:()=>p,frontMatter:()=>s,metadata:()=>i,toc:()=>u});var r=n(7462),l=(n(7294),n(3905));const s={slug:"newinstall",title:"Installer la caisse TiBillet sur Ubuntu 22.04",authors:"jonas",wiktags:["tibillet","cashless","ubuntu","linux","wallet","caisse","caisse enregistreuse"],image:"/img/federons/decollage.jpg",description:"Installation d'un serveur cashless."},a=void 0,i={permalink:"/blog/newinstall",editUrl:"https://github.com/TiBillet/documentation/tree/main/tibillet/blog/2023-07-28-Administration_serveur.md",source:"@site/blog/2023-07-28-Administration_serveur.md",title:"Installer la caisse TiBillet sur Ubuntu 22.04",description:"Installation d'un serveur cashless.",date:"2023-07-28T00:00:00.000Z",formattedDate:"28 juillet 2023",tags:[],readingTime:3.01,hasTruncateMarker:!1,authors:[{name:"Jonas TURBEAUX",title:"Niveau 42.",url:"https://github.com/Nasjoe",imageURL:"https://avatars.githubusercontent.com/u/2736977?s=96&v=4",key:"jonas"}],frontMatter:{slug:"newinstall",title:"Installer la caisse TiBillet sur Ubuntu 22.04",authors:"jonas",wiktags:["tibillet","cashless","ubuntu","linux","wallet","caisse","caisse enregistreuse"],image:"/img/federons/decollage.jpg",description:"Installation d'un serveur cashless."},prevItem:{title:"FEDOW",permalink:"/blog/federation-part5-fedow"},nextItem:{title:"F\xe9d\xe9ration 4 - Design",permalink:"/blog/federation-part4"}},o={authorsImageUrls:[void 0]},u=[{value:"Pr\xe9paration du syst\xe8me",id:"pr\xe9paration-du-syst\xe8me",level:2},{value:"Mises \xe0 jour du syst\xe8me",id:"mises-\xe0-jour-du-syst\xe8me",level:3},{value:"S\xe9curiser le serveur",id:"s\xe9curiser-le-serveur",level:3},{value:"Connexion SHH par cl\xe9",id:"connexion-shh-par-cl\xe9",level:4},{value:"Installer Crowdsec",id:"installer-crowdsec",level:4},{value:"Changer le port d&#39;\xe9coute du service SSH",id:"changer-le-port-d\xe9coute-du-service-ssh",level:4},{value:"Installation des d\xe9pendances",id:"installation-des-d\xe9pendances",level:3},{value:"Docker :",id:"docker-",level:4},{value:"Traefik",id:"traefik",level:4},{value:"Sentry",id:"sentry",level:4},{value:"TiBillet Cashless",id:"tibillet-cashless",level:4}],c={toc:u};function p(e){let{components:t,...s}=e;return(0,l.kt)("wrapper",(0,r.Z)({},c,s,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"/img/federons/decollage.jpg",src:n(8700).Z,width:"512",height:"512"})),(0,l.kt)("p",null,":::\nJuillet 2023 : Le cashless est en plein migration d'un Django 2.2 vers un 4.2. Le d\xe9pot libre n'est pas compl\xe8tement a\njour, contactez\nnous si vous voulez faire une installation.\n:::"),(0,l.kt)("p",null,"Nous allons d\xe9tailler ici la pr\xe9paration d'un serveur sous VPS pour acceuillir la solution de caisse TiBillet."),(0,l.kt)("h2",{id:"pr\xe9paration-du-syst\xe8me"},"Pr\xe9paration du syst\xe8me"),(0,l.kt)("h3",{id:"mises-\xe0-jour-du-syst\xe8me"},"Mises \xe0 jour du syst\xe8me"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"sudo apt update\nsudo apt upgrade -y\nsudo reboot\n")),(0,l.kt)("h3",{id:"s\xe9curiser-le-serveur"},"S\xe9curiser le serveur"),(0,l.kt)("h4",{id:"connexion-shh-par-cl\xe9"},"Connexion SHH par cl\xe9"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"# Depuis votre ordinateur client\nssh-copy-id <user>@<ip>\n# ou ajouter votre cle id_rsa.pub directement sur le serveur \nnano .ssh/authorized_keys \n")),(0,l.kt)("h4",{id:"installer-crowdsec"},"Installer Crowdsec"),(0,l.kt)("p",null,"Crowdsec est une solution open source tr\xe8s utile pour g\xe9rer la s\xe9curit\xe9 de votre serveur.\nIl utilise une liste de banissement d'ip g\xe9r\xe9 par la communaut\xe9, surveille les iptables, et peut m\xeame s'interfacer avec\nun reverse proxy pour surveiller les requetes http. Plus d'info ici :"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://www.crowdsec.net/"},"https://www.crowdsec.net/")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://plugins.traefik.io/plugins/6335346ca4caa9ddeffda116/crowdsec-bouncer-traefik-plugin"},"https://plugins.traefik.io/plugins/6335346ca4caa9ddeffda116/crowdsec-bouncer-traefik-plugin"))),(0,l.kt)("p",null,"Avant d'installer la solution, il est n\xe9c\xe9ssaire de cr\xe9er un compte gratuit sur leur site."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"curl -s https://packagecloud.io/install/repositories/crowdsec/crowdsec/script.deb.sh | sudo bash\nsudo apt-get install crowdsec\nsudo apt install crowdsec-firewall-bouncer-iptables\n")),(0,l.kt)("p",null,"Allez sur l'interface Crowdsec et g\xe9n\xe9rez votre token d'invitation :"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://app.crowdsec.net/security-engines"},"https://app.crowdsec.net/security-engines"))),(0,l.kt)("p",null,"Une commande du type suivant vous sera propos\xe9 :"),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"sudo cscli console enroll ****")),(0,l.kt)("p",null,"Lancez la, puis accepter l'invitation sur l'interface web."),(0,l.kt)("p",null,"Rebootez le serveur."),(0,l.kt)("h4",{id:"changer-le-port-d\xe9coute-du-service-ssh"},"Changer le port d'\xe9coute du service SSH"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"sudo nano /etc/ssh/sshd_config\n# Port 22\nPort 2252 # choisissez un port entre 1024 et 65535\n\n# On en profite pour autoriser l'agent forwarding\n# Cela sera tr\xe9s utile pour pull/push des d\xe9pots git avec sa propre identit\xe9\n# plut\xf4t que celle du serveur.\nAllowAgentForwarding yes\n")),(0,l.kt)("p",null,"On recharge le daemon ssh :"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"sudo service sshd reload\n")),(0,l.kt)("h3",{id:"installation-des-d\xe9pendances"},"Installation des d\xe9pendances"),(0,l.kt)("p",null,"Mes ptits softs que j'aime utiliser :"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"sudo apt update\nsudo apt install git byobu htop borgbackup\n\n")),(0,l.kt)("h4",{id:"docker-"},"Docker :"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://docs.docker.com/engine/install/ubuntu/"},"https://docs.docker.com/engine/install/ubuntu/"))),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"# Un script d'installation est disponible, si vous ne voulez pas le faire a la main.\ncurl -fsSL https://get.docker.com -o get-docker.sh\n# Attention ! V\xe9rifiez toujours le contenus des scripts t\xe9l\xe9charg\xe9 avant de les lancer en sudo ! \nsudo sh get-docker.sh\n# Ajoutez votre utilisteur au groupe docker\nsudo usermod -aG docker $USER\n")),(0,l.kt)("p",null,"Relancez une nouvelle session utilisateur pour prendre en compte les changements de groupes et v\xe9rifiez que vous avez\nbien les droits :"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"docker ps\n")),(0,l.kt)("h4",{id:"traefik"},"Traefik"),(0,l.kt)("p",null,"Traefik est un service de reverse proxy. C'est lui qui g\xe8re la redirection du conteneur depuis votre DNS et qui s'occupe\ndu chiffrement HTTPS gr\xe2ce \xe0 la formidable initiavide de lets'encrypt."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},'#clonez le d\xe9pot\ngit clone git@github.com:TiBillet/Traefik-reverse-proxy.git\ncd Traefik-reverse-proxy\n# Creez le sous r\xe9seau "frontend" commun\ndocker network create frontend\n# Lancez les conteneur en mode daemon\ndocker compose up -d\n# V\xe9rifiez que le conteneur tourne et qu\'il \xe9coute bien les ports 80 et 443 :\ndocker ps\n')),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},'CONTAINER ID   IMAGE               COMMAND                  CREATED         STATUS         PORTS                                                                    NAMES\n7f27255b935a   traefik:chevrotin   "/entrypoint.sh --lo\u2026"   5 seconds ago   Up 4 seconds   0.0.0.0:80->80/tcp, :::80->80/tcp, 0.0.0.0:443->443/tcp, :::443->443/tcp traefik\n')),(0,l.kt)("h4",{id:"sentry"},"Sentry"),(0,l.kt)("p",null,"TiBillet utilise sentry pour la remont\xe9e des bugs et des alertes.\nIndiquer une cl\xe9 api sentry est optionnel mais largement conseill\xe9e pour l'autohebergement."),(0,l.kt)("h4",{id:"tibillet-cashless"},"TiBillet Cashless"),(0,l.kt)("p",null,"Aller r\xe9cup\xe9rer la derni\xe8re version du d\xe9pot cashless sur ",(0,l.kt)("a",{parentName:"p",href:"https://github.com/TiBillet/TiBillet"},"https://github.com/TiBillet/TiBillet")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"git clone https://github.com/TiBillet/Cashless\ncd Cashless/Docker\n")),(0,l.kt)("p",null,"Remplissez toute les variables n\xe9c\xe9ssaires au lancement de votre instance."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"cp env_example .env\nnano .env\n")),(0,l.kt)("p",null,"Lancez les conteneurs et lancez les scripts de premiers lancement pour l'installation."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"docker compose up -d\ndocker compose exec cashless_django python manage.py migrate\ndocker compose exec cashless_django python manage.py popdb\n")))}p.isMDXComponent=!0},8700:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/decollage-4089ffd3f23c7012f1b8fa9b7474f30d.jpg"}}]);